@page "/server-login"
@using Microsoft.AspNetCore.Identity
@using JobBridge.Data
@using JobBridge.Services
@using Microsoft.JSInterop
@inject UserManager<JobBridge.Data.User> UserManager
@inject NavigationManager Navigation
@inject SessionAuthService SessionAuth
@inject IJSRuntime JSRuntime

<h3>Completing Login...</h3>

@code { // This is the code block for the server login page
    [Parameter]
    [SupplyParameterFromQuery]
    public string? Email { get; set; } // Email address of the user

    [Parameter]
    [SupplyParameterFromQuery]
    public bool Remember { get; set; } // Remember login state

    protected override async Task OnInitializedAsync() // This is the initialization handler
    {
        if (!string.IsNullOrEmpty(Email))
        {
            try
            {
                var user = await UserManager.FindByEmailAsync(Email); // Find user by email
                if (user == null)
                {
                    user = await UserManager.FindByNameAsync(Email); // Find user by name
                }

                if (user != null)
                {
                    Console.WriteLine($"Signing in user: {user.Email} with role: {user.Role}, Remember: {Remember}");
                    await SessionAuth.SignInAsync(JSRuntime, user.Id, user.Email, user.UserName ?? user.Email, user.Role, user.FirstName, Remember);
                    Console.WriteLine("SessionAuth.SignIn completed");
                    Navigation.NavigateTo("/");
                    return; // Successful login
                }
                Console.WriteLine("User not found"); // User not found
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in ServerLogin: {ex.Message}"); // Log the error
            }
        }
        Navigation.NavigateTo("/"); // Redirect to home page if login fails
    }
}